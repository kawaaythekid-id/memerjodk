-- LocalScript (StarterPlayerScripts)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- ===== SETTINGS =====
local SETTINGS = {
    enabled = false,
    maxDistance = 250,
    smoothing = 0.14,
    aimPartName = "Head", -- "Head" atau "HumanoidRootPart"
    headOnly = false,
    autoEquip = true,
}

-- ===== GUI =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AimbotGUI"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(0, 120, 0, 50)
ToggleButton.Position = UDim2.new(0.05, 0, 0.8, 0)
ToggleButton.Text = "Aimbot: OFF"
ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextScaled = true
ToggleButton.Parent = ScreenGui

-- Crosshair
local Crosshair = Instance.new("Frame")
Crosshair.Size = UDim2.new(0, 10, 0, 10)
Crosshair.AnchorPoint = Vector2.new(0.5,0.5)
Crosshair.Position = UDim2.new(0.5,0,0.5,0)
Crosshair.BackgroundColor3 = Color3.new(1,0,0)
Crosshair.BorderSizePixel = 0
Crosshair.Visible = false
Crosshair.Parent = ScreenGui

-- ===== FUNCTIONS =====

-- Toggle GUI button
local function toggleAimbot()
    SETTINGS.enabled = not SETTINGS.enabled
    ToggleButton.Text = "Aimbot: " .. (SETTINGS.enabled and "ON" or "OFF")
    ToggleButton.BackgroundColor3 = SETTINGS.enabled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    Crosshair.Visible = SETTINGS.enabled
end

ToggleButton.MouseButton1Click:Connect(toggleAimbot)

-- Keyboard toggle (E)
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.E then
        toggleAimbot()
    end
end)

-- Cari musuh terdekat
local function getNearestPlayer()
    local closest, dist = nil, math.huge
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local aimPart = plr.Character:FindFirstChild(SETTINGS.aimPartName) or plr.Character:FindFirstChild("HumanoidRootPart")
            if SETTINGS.headOnly then
                aimPart = plr.Character:FindFirstChild("Head") or aimPart
            end
            local mag = (aimPart.Position - char.HumanoidRootPart.Position).Magnitude
            if mag < dist and mag <= SETTINGS.maxDistance then
                closest = plr
                dist = mag
            end
        end
    end
    return closest
end

-- Smooth aim ke target
local function aimAtTarget(target)
    if not target or not target.Character then return end
    local targetPart = target.Character:FindFirstChild(SETTINGS.aimPartName) or target.Character:FindFirstChild("HumanoidRootPart")
    if SETTINGS.headOnly then
        targetPart = target.Character:FindFirstChild("Head") or targetPart
    end
    if not targetPart then return end

    local targetPos = targetPart.Position
    local camPos = Camera.CFrame.Position
    local desiredCFrame = CFrame.new(camPos, targetPos)
    Camera.CFrame = Camera.CFrame:Lerp(desiredCFrame, math.clamp(SETTINGS.smoothing,0,1))

    -- Update crosshair
    local viewportPoint, onScreen = Camera:WorldToViewportPoint(targetPos)
    if onScreen then
        Crosshair.Position = UDim2.new(0, viewportPoint.X, 0, viewportPoint.Y)
    else
        Crosshair.Visible = false
    end
end

-- Auto-equip tool
local function autoEquipTool(tool)
    if not tool or not LocalPlayer.Character then return end
    local humanoid = LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
    if humanoid and tool.Parent ~= LocalPlayer.Character then
        pcall(function() humanoid:EquipTool(tool) end)
    end
end

-- Auto shoot
local function autoShoot()
    local char = LocalPlayer.Character
    if not char then return end
    local tool = char:FindFirstChildOfClass("Tool")
    if not tool and SETTINGS.autoEquip and LocalPlayer.Backpack then
        tool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool")
        if tool then autoEquipTool(tool) end
    end
    if tool then
        pcall(function() tool:Activate() end)
    end
end

-- ===== MAIN LOOP =====
RunService.RenderStepped:Connect(function()
    if SETTINGS.enabled then
        local target = getNearestPlayer()
        if target then
            aimAtTarget(target)
            autoShoot()
        end
    end
end)
