-- LocalScript Fly Custom untuk Mobile/Android
-- Taruh di StarterPlayer > StarterPlayerScripts
-- Fitur: GUI draggable, TextBox untuk speed (max 99999), up/down buttons, toggle fly, invisible, minimize/close

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local GuiService = game:GetService("GuiService")

local player = Players.LocalPlayer
local character = player.Character
local humanoid, rootPart

-- Fungsi untuk menunggu karakter dengan timeout
local function waitForCharacter(timeout)
    timeout = timeout or 10
    local start = tick()
    while not player.Character and tick() - start < timeout do
        player.CharacterAdded:Wait()
    end
    return player.Character
end

-- Inisialisasi karakter
if not character then
    character = waitForCharacter()
end
if character then
    humanoid = character:WaitForChild("Humanoid", 5)
    rootPart = character:WaitForChild("HumanoidRootPart", 5)
end
if not humanoid or not rootPart then
    warn("Failed to initialize character!")
    return
end

local flying = false
local invisible = false
local speed = 50  -- Default speed
local bodyVelocity = nil
local bodyGyro = nil
local connections = {}  -- Tabel untuk menyimpan koneksi

-- Buat GUI (ScreenGui)
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Frame utama (draggable)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 200, 0, 250)
mainFrame.Position = UDim2.new(0, 10, 0, 10)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 0
mainFrame.ZIndex = 10
mainFrame.Parent = screenGui

-- Tambah UICorner untuk frame
local frameCorner = Instance.new("UICorner")
frameCorner.CornerRadius = UDim.new(0, 8)
frameCorner.Parent = mainFrame

-- Buat draggable (support touch)
local dragging = false
local dragInput, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch and dragging then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Fungsi untuk styling tombol
local function styleButton(button)
    button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.SourceSansBold
    button.ZIndex = 11
    button.Active = true
    button.Selectable = true
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = button
end

-- Tombol Minimize
local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 30, 0, 30)
minimizeButton.Position = UDim2.new(1, -60, 0, 0)
minimizeButton.Text = "-"
minimizeButton.Parent = mainFrame
styleButton(minimizeButton)
minimizeButton.Activated:Connect(function()
    if mainFrame.Size == UDim2.new(0, 200, 0, 250) then
        mainFrame.Size = UDim2.new(0, 200, 0, 30)  -- Minimize
        minimizeButton.Text = "+"
    else
        mainFrame.Size = UDim2.new(0, 200, 0, 250)  -- Maximize
        minimizeButton.Text = "-"
    end
end)

-- Tombol Close (X)
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 30, 0, 30)
closeButton.Position = UDim2.new(1, -30, 0, 0)
closeButton.Text = "X"
closeButton.Parent = mainFrame
styleButton(closeButton)
closeButton.Activated:Connect(function()
    screenGui.Enabled = false
end)

-- Tombol Toggle Fly
local flyButton = Instance.new("TextButton")
flyButton.Size = UDim2.new(1, 0, 0, 40)
flyButton.Position = UDim2.new(0, 0, 0, 30)
flyButton.Text = "Fly: Off"
flyButton.Parent = mainFrame
styleButton(flyButton)
flyButton.Activated:Connect(function()
    print("Fly button activated!")
    if flying then
        print("Stopping fly")
        stopFly()
        flyButton.Text = "Fly: Off"
    else
        print("Starting fly")
        startFly()
        flyButton.Text = "Fly: On"
    end
end)

-- TextBox untuk Speed
local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(1, 0, 0, 30)
speedLabel.Position = UDim2.new(0, 0, 0, 70)
speedLabel.Text = "Speed: 50"
speedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
speedLabel.BackgroundTransparency = 1
speedLabel.ZIndex = 11
speedLabel.Parent = mainFrame

local speedBox = Instance.new("TextBox")
speedBox.Size = UDim2.new(1, 0, 0, 30)
speedBox.Position = UDim2.new(0, 0, 0, 100)
speedBox.Text = "50"
speedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
speedBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
speedBox.ZIndex = 11
speedBox.Parent = mainFrame
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = speedBox
speedBox.FocusLost:Connect(function()
    local newSpeed = tonumber(speedBox.Text)
    if newSpeed and newSpeed >= 20 and newSpeed <= 99999 then
        speed = math.floor(newSpeed)
        speedLabel.Text = "Speed: " .. speed
    else
        speedBox.Text = tostring(speed)
        warn("Invalid speed! Must be a number between 20 and 99999.")
    end
end)

-- Tombol Up
local upButton = Instance.new("TextButton")
upButton.Size = UDim2.new(0.5, 0, 0, 40)
upButton.Position = UDim2.new(0, 0, 0, 130)
upButton.Text = "Up"
upButton.Parent = mainFrame
styleButton(upButton)
local upPressed = false
upButton.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch then upPressed = true end end)
upButton.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch then upPressed = false end end)

-- Tombol Down
local downButton = Instance.new("TextButton")
downButton.Size = UDim2.new(0.5, 0, 0, 40)
downButton.Position = UDim2.new(0.5, 0, 0, 130)
downButton.Text = "Down"
downButton.Parent = mainFrame
styleButton(downButton)
local downPressed = false
downButton.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch then downPressed = true end end)
downButton.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.Touch then downPressed = false end end)

-- Toggle Invisible
local invisibleButton = Instance.new("TextButton")
invisibleButton.Size = UDim2.new(1, 0, 0, 40)
invisibleButton.Position = UDim2.new(0, 0, 0, 170)
invisibleButton.Text = "Invisible: Off"
invisibleButton.Parent = mainFrame
styleButton(invisibleButton)
invisibleButton.Activated:Connect(function()
    invisible = not invisible
    invisibleButton.Text = "Invisible: " .. (invisible and "On" or "Off")
    setInvisible(invisible)
end)

local function setInvisible(state)
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") or part:IsA("MeshPart") then
            if not part:IsA("BillboardGui") and not part:IsA("ParticleEmitter") then
                part.Transparency = state and 1 or (part:FindFirstChild("OriginalTransparency") and part.OriginalTransparency.Value or 0)
            end
        end
    end
end

local function startFly()
    if flying then return end
    if not character or not humanoid or not rootPart then
        warn("Character, Humanoid, or RootPart not found!")
        return
    end
    print("Starting fly...")
    flying = true
    humanoid.PlatformStand = true
    
    pcall(function()
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = rootPart
        
        bodyGyro = Instance.new("BodyGyro")
        bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bodyGyro.CFrame = rootPart.CFrame
        bodyGyro.Parent = rootPart
    end)
    
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not flying or not bodyVelocity or not bodyGyro then
            if connection then connection:Disconnect() end
            return
        end
        
        local camera = workspace.CurrentCamera
        if not camera then
            warn("Camera not found!")
            return
        end
        
        local moveVector = humanoid.MoveDirection
        local velocity = camera.CFrame:VectorToWorldSpace(moveVector) * speed
        
        if upPressed then
            velocity = velocity + Vector3.new(0, speed, 0)
        elseif downPressed then
            velocity = velocity + Vector3.new(0, -speed, 0)
        end
        
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
            velocity = velocity + Vector3.new(0, speed, 0)
        elseif UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            velocity = velocity + Vector3.new(0, -speed, 0)
        end
        
        bodyVelocity.Velocity = velocity
        bodyGyro.CFrame = camera.CFrame
    end)
    table.insert(connections, connection)
    
    pcall(function()
        TweenService:Create(rootPart, TweenInfo.new(0.5), {CFrame = rootPart.CFrame + Vector3.new(0, 5, 0)}):Play()
    end)
end

local function stopFly()
    if not flying then return end
    print("Stopping fly...")
    flying = false
    humanoid.PlatformStand = false
    
    for _, connection in ipairs(connections) do
        connection:Disconnect()
    end
    connections = {}
    
    if bodyVelocity then bodyVelocity:Destroy() bodyVelocity = nil end
    if bodyGyro then bodyGyro:Destroy() bodyGyro = nil end
    
    pcall(function()
        TweenService:Create(rootPart, TweenInfo.new(0.5), {CFrame = rootPart.CFrame - Vector3.new(0, 5, 0)}):Play()
    end)
end

-- Handle respawn
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid", 5)
    rootPart = character:WaitForChild("HumanoidRootPart", 5)
    if not humanoid or not rootPart then
        warn("Failed to initialize new character!")
        screenGui.Enabled = false
        return
    end
    if flying then startFly() end
    setInvisible(invisible)
end)

-- Tampilkan GUI
screenGui.Enabled = true
