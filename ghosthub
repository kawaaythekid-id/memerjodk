local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ContextActionService = game:GetService("ContextActionService")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local camera = workspace.CurrentCamera

local inGhostMode = false
local ghostPart = nil
local originalPosition = nil
local moveDirection = Vector3.new(0, 0, 0)

-- Membuat UI untuk Android
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Parent = player:WaitForChild("PlayerGui")
    screenGui.Name = "GhostModeUI"
    screenGui.ResetOnSpawn = false

    -- Tombol Minimize (aktifkan ghost mode)
    local minimizeButton = Instance.new("TextButton")
    minimizeButton.Size = UDim2.new(0, 100, 0, 50)
    minimizeButton.Position = UDim2.new(0, 10, 0, 10)
    minimizeButton.Text = "Minimize"
    minimizeButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.Parent = screenGui

    -- Tombol X (nonaktifkan ghost mode)
    local xButton = Instance.new("TextButton")
    xButton.Size = UDim2.new(0, 50, 0, 50)
    xButton.Position = UDim2.new(0, 120, 0, 10)
    xButton.Text = "X"
    xButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    xButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    xButton.Parent = screenGui
    xButton.Visible = false -- Sembunyikan tombol X saat awal

    return screenGui, minimizeButton, xButton
end

local screenGui, minimizeButton, xButton = createUI()

-- Fungsi untuk mengaktifkan ghost mode
local function activateGhostMode()
    if inGhostMode then return end
    inGhostMode = true
    originalPosition = rootPart.Position -- Simpan posisi awal (posisi A)

    -- Buat karakter asli transparan dan statis
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            part.Transparency = 0.7
            part.CanCollide = false
        end
    end
    rootPart.Anchored = true
    humanoid.WalkSpeed = 0

    -- Buat entitas hantu
    ghostPart = Instance.new("Part")
    ghostPart.Size = Vector3.new(0.1, 0.1, 0.1)
    ghostPart.Transparency = 1
    ghostPart.CanCollide = false
    ghostPart.Anchored = false
    ghostPart.Position = originalPosition
    ghostPart.Parent = workspace

    -- Atur kamera ke entitas hantu
    camera.CameraSubject = ghostPart
    camera.CameraType = Enum.CameraType.Follow

    -- Tampilkan tombol X, sembunyikan Minimize
    minimizeButton.Visible = false
    xButton.Visible = true

    print("Ghost mode ON")
end

-- Fungsi untuk menonaktifkan ghost mode
local function deactivateGhostMode()
    if not inGhostMode then return end
    inGhostMode = false

    -- Pindahkan karakter ke posisi ghostPart (posisi B)
    if ghostPart then
        rootPart.Position = ghostPart.Position
        ghostPart:Destroy()
        ghostPart = nil
    end

    -- Kembalikan karakter ke normal
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            part.Transparency = 0
            part.CanCollide = true
        end
    end
    rootPart.Anchored = false
    humanoid.WalkSpeed = 16

    -- Kembalikan kamera ke karakter
    camera.CameraSubject = humanoid
    camera.CameraType = Enum.CameraType.Custom

    -- Tampilkan tombol Minimize, sembunyikan X
    minimizeButton.Visible = true
    xButton.Visible = false

    print("Ghost mode OFF")
end

-- Kontrol gerakan untuk PC (WASD)
local function handleInput(input, gameProcessed)
    if gameProcessed or not inGhostMode then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == Enum.KeyCode.W then
            moveDirection = moveDirection + Vector3.new(0, 0, -1)
        elseif input.KeyCode == Enum.KeyCode.S then
            moveDirection = moveDirection + Vector3.new(0, 0, 1)
        elseif input.KeyCode == Enum.KeyCode.A then
            moveDirection = moveDirection + Vector3.new(-1, 0, 0)
        elseif input.KeyCode == Enum.KeyCode.D then
            moveDirection = moveDirection + Vector3.new(1, 0, 0)
        end
    end
end

local function handleInputEnd(input)
    if not inGhostMode then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == Enum.KeyCode.W then
            moveDirection = moveDirection - Vector3.new(0, 0, -1)
        elseif input.KeyCode == Enum.KeyCode.S then
            moveDirection = moveDirection - Vector3.new(0, 0, 1)
        elseif input.KeyCode == Enum.KeyCode.A then
            moveDirection = moveDirection - Vector3.new(-1, 0, 0)
        elseif input.KeyCode == Enum.KeyCode.D then
            moveDirection = moveDirection - Vector3.new(1, 0, 0)
        end
    end
end

-- Virtual joystick untuk Android
local joystickActive = false
local joystickOrigin = nil
local joystickDelta = Vector2.new(0, 0)

local function createJoystick()
    local joystickGui = Instance.new("ScreenGui")
    joystickGui.Parent = player:WaitForChild("PlayerGui")
    joystickGui.Name = "JoystickGui"
    joystickGui.Enabled = false

    local joystickFrame = Instance.new("Frame")
    joystickFrame.Size = UDim2.new(0, 100, 0, 100)
    joystickFrame.Position = UDim2.new(0, 50, 0.5, 0)
    joystickFrame.BackgroundTransparency = 0.5
    joystickFrame.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    joystickFrame.Parent = joystickGui

    local joystickKnob = Instance.new("Frame")
    joystickKnob.Size = UDim2.new(0, 40, 0, 40)
    joystickKnob.Position = UDim2.new(0.5, -20, 0.5, -20)
    joystickKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    joystickKnob.Parent = joystickFrame

    return joystickGui, joystickFrame, joystickKnob
end

local joystickGui, joystickFrame, joystickKnob = createJoystick()

-- Logika joystick untuk Android
UserInputService.TouchStarted:Connect(function(touch, gameProcessed)
    if gameProcessed or not inGhostMode then return end
    joystickActive = true
    joystickOrigin = touch.Position
    joystickFrame.Position = UDim2.new(0, joystickOrigin.X - 50, 0, joystickOrigin.Y - 50)
    joystickGui.Enabled = true
end)

UserInputService.TouchMoved:Connect(function(touch, gameProcessed)
    if not joystickActive or not inGhostMode then return end
    local delta = touch.Position - joystickOrigin
    local maxRadius = 50
    if delta.Magnitude > maxRadius then
        delta = delta.Unit * maxRadius
    end
    joystickKnob.Position = UDim2.new(0.5, delta.X - 20, 0.5, delta.Y - 20)
    joystickDelta = delta / maxRadius
end)

UserInputService.TouchEnded:Connect(function(touch, gameProcessed)
    joystickActive = false
    joystickGui.Enabled = false
    joystickKnob.Position = UDim2.new(0.5, -20, 0.5, -20)
    joystickDelta = Vector2.new(0, 0)
end)

-- Update gerakan ghostPart
RunService.RenderStepped:Connect(function(dt)
    if inGhostMode and ghostPart then
        local moveSpeed = 20
        local direction = Vector3.new(0, 0, 0)
        if GuiService:IsTenFootInterface() or UserInputService.TouchEnabled then
            -- Gunakan joystick untuk Android
            direction = camera.CFrame:VectorToWorldSpace(Vector3.new(joystickDelta.X, 0, -joystickDelta.Y)).Unit * moveSpeed
        else
            -- Gunakan WASD untuk PC
            direction = camera.CFrame:VectorToWorldSpace(moveDirection).Unit * moveSpeed
        end
        if direction.Magnitude > 0 then
            ghostPart.Position = ghostPart.Position + direction * dt
        end
    end
end)

-- Bind tombol UI
minimizeButton.MouseButton1Click:Connect(activateGhostMode)
xButton.MouseButton1Click:Connect(deactivateGhostMode)

-- Bind input keyboard
UserInputService.InputBegan:Connect(handleInput)
UserInputService.InputEnded:Connect(handleInputEnd)

-- Handle karakter baru
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    if not inGhostMode then
        camera.CameraSubject = humanoid
        camera.CameraType = Enum.CameraType.Custom
        minimizeButton.Visible = true
        xButton.Visible = false
        joystickGui.Enabled = false
    end
end)
